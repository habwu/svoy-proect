image: python:3.12

cache:
  paths:
    - .pip_cache/

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip_cache"

stages:
  - cleanup   # Стадия для очистки
  - deploy    # Стадия для деплоя

########################################
# ЭТАП ОЧИСТКИ ДЛЯ ВЕТКИ DEVELOP
########################################
cleanup_develop:
  stage: cleanup
  script:
    - echo "Подготовка к очистке на тестовом сервере..."
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - cp "$SSH_PRIVATE_KEY" ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$SERVER_IP_TEST" >> ~/.ssh/known_hosts

    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no "$DEPLOY_USER@$SERVER_IP_TEST" bash -s << 'EOF'
      set -e
      set -o pipefail

      echo "Очистка старых логов/файлов на тестовом сервере..."
      
      
      cd "/var/www/www-root/data/www/test-old.olimpteam.ru"
      rm -rf old_logs
      mkdir old_logs
      # Ниже — подставьте свою логику

      echo "Очистка на тестовом сервере завершена."
      EOF
  only:
    - develop

########################################
# ЭТАП ОЧИСТКИ ДЛЯ ВЕТКИ MAIN
########################################
cleanup_main:
  stage: cleanup
  script:
    - echo "Подготовка к очистке на боевом сервере..."
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - cp "$SSH_PRIVATE_KEY" ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$SERVER_IP_PROD" >> ~/.ssh/known_hosts

    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no "$DEPLOY_USER@$SERVER_IP_PROD" bash -s << 'EOF'
      set -e
      set -o pipefail

      echo "Очистка старых логов/файлов на боевом сервере..."
      
      cd "/var/www/www-root/data/www/olympiad.olimpteam.ru/OlimpOlympiadOld"
      rm -rf old_logs
      mkdir old_logs
      # Ниже — подставьте свою логику

      echo "Очистка на боевом сервере завершена."
      EOF
  only:
    - main

########################################
# ДЕПЛОЙ НА ТЕСТОВЫЙ СЕРВЕР
########################################
deploy_to_develop:
  stage: deploy
  script:
    # Настраиваем SSH-доступ
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh

    - cp "$SSH_PRIVATE_KEY" ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa

    # Добавляем сервер в known_hosts
    - ssh-keyscan -H "$SERVER_IP_TEST" >> ~/.ssh/known_hosts

    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no "$DEPLOY_USER@$SERVER_IP_TEST" bash -s << 'EOF'
      set -e
      set -o pipefail

      cd "/var/www/www-root/data/www/test-old.olimpteam.ru"
      git reset --hard
      echo "Обновление проекта из репозитория (ветка develop)..."
      git pull origin develop

      echo "Выполнение миграций..."
      python manage.py migrate
      echo "Сборка статических файлов..."
      python manage.py collectstatic --noinput

      echo "Перезапуск приложения (тестовый сервер)..."
      touch reload

      echo "Деплой на тестовый сервер завершён!"
      EOF
  only:
    - develop
  dependencies:
    - cleanup_develop

########################################
# ДЕПЛОЙ НА БОЕВОЙ СЕРВЕР
########################################
deploy_to_production:
  stage: deploy
  script:
    # Настраиваем SSH-доступ
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh

    # Используем переменную типа "File" для приватного ключа
    - cp "$SSH_PRIVATE_KEY" ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa

    # Добавляем сервер в known_hosts
    - ssh-keyscan -H "$SERVER_IP_PROD" >> ~/.ssh/known_hosts

    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no "$DEPLOY_USER@$SERVER_IP_PROD" bash -s << 'EOF'
      set -e
      set -o pipefail

      cd "/var/www/www-root/data/www/api.olimpteam.ru/OlimpOlympiadAPI"
      echo "Найдена директория..."
      git reset --hard
      echo "Обновление проекта из репозитория (ветка main)..."
      git pull origin main

      echo "Выполнение миграций..."
      python manage.py migrate
      echo "Сборка статических файлов..."
      python manage.py collectstatic --noinput

      echo "Перезапуск приложения (боевой сервер)..."
      touch reload

      echo "Деплой успешно завершён!"
      EOF
  only:
    - main
  dependencies:
    - cleanup_main  # Деплой будет зависеть от успешной "cleanup" на main
